{% extends 'base.html' %}
{% load static %}

{% block title %}「{{ query }}」の検索結果{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <h3 class="text-center mb-4">検索結果</h3>

            <div class="search-results">
                {% if results.blog_posts or results.users or results.tags or results.users_with_tag %}

                    {# ブログ投稿の表示 #}
                    {% if results.blog_posts %}
                    <h4 class="mb-3">その文言が含まれている投稿:</h4>
                    <div class="list-group mb-4">
                        {% for post in results.blog_posts %}
                        <a href="{% url 'blog:post_detail' post.id %}" class="list-group-item list-group-item-action">
                            <h5 class="mb-1">{{ post.title }}</h5>
                            <small class="text-muted">{{ post.author.username }} | {{ post.created_at|date:"Y年m月d日" }}</small>
                            <p class="mb-1">{{ post.content|truncatechars:100 }}</p>
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# ユーザーの表示 #}
                    {% if results.users or results.users_with_tag %}
                    <h4 class="mb-3">おそらくあなたが興味のあるユーザー:</h4>
                    <div class="row g-4">
                        {% for user in results.users %}
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2 text-center">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body d-flex flex-column align-items-center">
                                    <a href="{% url 'users:user_profile_detail' user.id %}">
                                        {% if user.avatar %}
                                            <img src="{{ user.avatar.url }}" alt="アバター画像" class="rounded-circle mb-2" style="width: 64px; height: 64px; object-fit: cover;">
                                        {% else %}
                                            <img src="{% static 'images/default_avatar.png' %}" alt="デフォルトアバター" class="rounded-circle mb-2" style="width: 64px; height: 64px; object-fit: cover;">
                                        {% endif %}
                                    </a>
                                    <div class="fw-semibold text-dark mb-1">{{ user.username }}</div>
                                    <div class="text-muted small mb-2">
                                        フォロワー: {{ user.followers_count }}
                                    </div>
                                    <div class="mt-auto">
                                        {% if user.prefetched_user_tags %}
                                            {% for ut in user.prefetched_user_tags|slice:":3" %}
                                                <span class="badge bg-primary">#{{ ut.tag.name }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">タグなし</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        {# タグを持つユーザーも同様に表示 #}
                        {% for user in results.users_with_tag %}
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2 text-center">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body d-flex flex-column align-items-center">
                                    <a href="{% url 'users:user_profile_detail' user.id %}">
                                        {% if user.avatar %}
                                            <img src="{{ user.avatar.url }}" alt="アバター画像" class="rounded-circle mb-2" style="width: 64px; height: 64px; object-fit: cover;">
                                        {% else %}
                                            <img src="{% static 'images/default_avatar.png' %}" alt="デフォルトアバター" class="rounded-circle mb-2" style="width: 64px; height: 64px; object-fit: cover;">
                                        {% endif %}
                                    </a>
                                    <div class="fw-semibold text-dark mb-1">{{ user.username }}</div>
                                
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {# タグはリスト形式のまま #}
                    {% if results.tags %}
                    <h4 class="mb-3 mt-4">タグ:</h4>
                    <div class="d-flex flex-wrap gap-2">
                        {% for tag in results.tags %}
                            <span class="badge bg-secondary">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                {% else %}
                    <p class="text-center">「{{ query }}」に一致するコンテンツは見つかりませんでした。</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}